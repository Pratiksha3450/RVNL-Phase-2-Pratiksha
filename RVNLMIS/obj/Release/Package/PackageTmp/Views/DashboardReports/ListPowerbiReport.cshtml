
@{
    ViewBag.Title = "ListPowerbiReport";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="~/Scripts/kendo.all.min.js"></script>
<script src="~/Scripts/kendo.aspnetmvc.min.js"></script>

<div class="modal fade" id="createReportModal" tabindex="-1" role="dialog" aria-labelledby="createReportModal" aria-hidden="true" data-backdrop="static">
    <div id="createReportContainer" class="modal-dialog modal-lg">

    </div>
</div>

<div class="content_wrapper">
    <div class=" ">
        @*<div class="page-header">

            </div>*@
        <!-- [ Main Content ] start -->
        <div class="row">
            @*<div class="col-sm-4" id="divReportTableAddEdit">
                    @Html.Partial("_PartialCreateEdit", new RVNLMIS.Models.PowerbiReportData())
                </div>*@

            <!-- [ horizontal-layout ] start -->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Existing Reports</h5>
                            </div>


                            <div class="col-md-4">
                                <div class="full-width">
                                    <div class="input-group input-group-sm">
                                        <input type="search" id="searching" class="form-control divMag mr-4" placeholder="Search by  Report Id ,Workspace Id" aria-label="Small"
                                               aria-describedby="inputGroup-sizing-sm" width="30%" />

                                        <button type="submit" class="btn btn-sm btn-outline-primary" href="javascript:void()" data-url="/DashboardReports/AddEditPowerbiReportInfo/0"
                                                id="btnAddEditReport" title="Add Report">
                                            <i class="fas fa-plus"></i> Add
                                        </button>

                                        <button type="submit" class="btn btn-sm btn-outline-primary ml-1" href="javascript:void()" data-url="/DashboardReports/RefreshAllDatasets"
                                                id="btnRefreshAllDS" title="Refresh All Datasets">
                                            <i class="fas fa-sync"></i> Refresh All Datasets
                                        </button>
                                    </div>

                                </div>


                            </div>


                            @*<div class="col-md-4 divMag">
                                    <div class="input-group input-group-sm">
                                        <input type="search" id="searching" class="form-control divMag" placeholder="Search by  Report Id ,Workspace Id" aria-label="Small" aria-describedby="inputGroup-sizing-sm" />
                                    </div>
                                </div>
                                <div class="col-md-1 text-right">
                                    <button type="submit" class="btn btn-sm btn-outline-primary" href="javascript:void()" data-url="/DashboardReports/AddEditPowerbiReportInfo/0" id="btnAddEditReport" title="Add Report"><i class="fas fa-plus"></i> Add</button>
                                </div>*@
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="" id="KendoHeight">

                            @(Html.Kendo().Grid<RVNLMIS.Models.PowerbiReportData>()
                                                                                        .Name("PowerbiReportInfoGrid")
                                                                                        .Columns(columns =>
                                                                                        {
                                                                                            columns.Template(t => { }).Title("#").ClientTemplate("#= renderNumber(data) #").Width("2%");
                                                                                            columns.Bound(c => c.ReportName).HtmlAttributes(new { style = "text-align:left" }).Width("10%")
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" });
                                                                                            columns.Bound(c => c.WorkSpaceId).HtmlAttributes(new { style = "text-align:left" }).Width("15%")
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" });
                                                                                            columns.Bound(c => c.ReportId).HtmlAttributes(new { style = "text-align:left" }).Width("15%")
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" });
                                                                                            columns.Bound(c => c.ApplicationId).HtmlAttributes(new { style = "text-align:left" }).Width("15%")
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" });
                                                                                            columns.Bound(c => c.ApplicationSecret).HtmlAttributes(new { style = "text-align:left" }).Width("15%")
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" });
                                                                                            columns.Bound(c => c.TenantId).HtmlAttributes(new { style = "text-align:left" })
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" }).Hidden();
                                                                                            columns.Bound(c => c.DatasetId).HtmlAttributes(new { style = "text-align:left" }).Width("15%")
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" });
                                                                                            columns.Bound(c => c.Description).HtmlAttributes(new { style = "text-align:center" })
                                                                                                        .HeaderHtmlAttributes(new { style = "text-align:center" }).Hidden();
                                                                                            columns.Bound(c => c.MenuName).Title("Menu Name").HtmlAttributes(new { style = "text-align:left" }).Width(130);
                                                                                            columns.Bound(c => c.GroupName).Title("Group Name").HtmlAttributes(new { style = "text-align:left" }).Hidden();
                                                                                                        //columns.Bound(c => c.URL).HtmlAttributes(new { style = "text-align:center" })
                                                                                                        //    .HeaderHtmlAttributes(new { style = "text-align:center" });
                                                                                                        columns.Template(@<text></text>).Title("Action").ClientTemplate("<button class='btn btn-xs btn-warning  has-ripple btnEditPBiReport' data-url='/DashboardReports/AddEditPowerbiReportInfo/#=Id#' title='Edit Details'><i class='feather icon-edit'></i></button>&nbsp;" +
                                                                            "<button class='btn btn-xs btn-danger has-ripple ConfirmDelete' data-key='#=Id#' title='Delete' data-toggle='modal'  ><i class='feather icon-trash'></i></button>"
                                                                            ).HeaderHtmlAttributes(new { style = "text-align:center" }).Width(80);
                                                                                    }).Scrollable(scr => scr.Height(400))
                                                            .Pageable()
                                                            .Sortable()
                                                            .Resizable(resize => resize.Columns(true))
                                                            .Pageable(pageable => pageable
                                                            .Refresh(true)
                                                            .PageSizes(true)
                                                            .ButtonCount(5)
                                                            .PageSizes(new List<object> { 10, 20, 50, "all" }).Refresh(true))
                                                            .PersistSelection(true)
                                                            .DataSource(dataSource => dataSource
                                                            .Ajax().Group(g => g.Add(c => c.GroupName))
                                                            .Model(model => model.Id(u => u.Id))
                                                            .Read(read => read.Action("PowerbiReport_Read", "DashboardReports"))
                                                            .PageSize(10))
.Events(events => events.DataBound("dataBound")))
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- [ horizontal-layout ] end -->
</div>
<!-- [ Main Content ] end -->

<div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">Confirm Delete</h5>
                <button id="btnCloseDelete" type="button" class="close btn-xs " data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>

            </div>
            <div class="modal-body">
                <input type="hidden" id="hiddenId" />
                <p class="success-message">Are you sure you wish to delete selected Report ?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success btn-sm delete-confirm" id="btnDeleteConfirm"><i class="fa fa-check"></i>&nbsp;Ok</button>
                <button class="btn btn-danger btn-sm" data-dismiss="modal"><i class="fa fa-times"></i>&nbsp;Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(window).resize(function () {
        $('#KendoHeight').height($(window).height() - 195);
        $('#PowerbiReportInfoGrid').height($(window).height() - 198);
    });
    $(window).trigger('resize');
    var rowNumber = 0;
    function resetRowNumber(e) {
        rowNumber = 0;
    }
    function renderNumber(data) {
        return ++rowNumber;
    }
    function GetValues() {
        var TenantId = $("#TenantId").val();
        var AppId = $("#ApplicationId").val();
        var AppSecret = $("#ApplicationSecret").val();
        return { TenantId: TenantId, AppId: AppId, AppSecret: AppSecret };
    }

    function GetGroupId() {
        var TenantId = $("#TenantId").val();
        var workSpaceId = $("#WorkSpaceId").data("kendoDropDownList").value();
        var AppId = $("#ApplicationId").val();
        var AppSecret = $("#ApplicationSecret").val();
        return { tenentID: TenantId, workSpaceId: workSpaceId, AppId: AppId, AppSecret: AppSecret };
    }

    function BindClickEvent() {
        $("#ApplicationId").change(function () {
            var tenentID = $("#TenantId").val();
            console.log(tenentID);
            var ApplicationSecret = $("#ApplicationSecret").val();
            var ApplicationId = $("#ApplicationId").val();

            if (tenentID == "" || tenentID == null) {
                $.notify("Please enter TenentId", { align: "right", verticalAlign: "top", type: "danger", background: "#ff0000", color: "#fff" });
            }
            else if (ApplicationSecret == "" || ApplicationSecret == null) {
                $.notify("Please enter Application Secret", { align: "right", verticalAlign: "top", type: "danger", background: "#ff0000", color: "#fff" });
            }
            else if (ApplicationId == "" || ApplicationId == null) {
                $.notify("Please enter Application Id", { align: "right", verticalAlign: "top", type: "danger", background: "#ff0000", color: "#fff" });
            }
            else {
                var projectDataSource;
                $.get("/DashboardReports/Get_Workspace", { TenantId: tenentID, AppId: ApplicationId, AppSecret: ApplicationSecret },
                    function (data) {
                        $("#WorkSpaceId").html('');
                        projectDataSource = data;
                        $("#WorkSpaceId").data("kendoDropDownList").setDataSource(new kendo.data.DataSource({ data: projectDataSource }));
                    });
            }
        });

        $("#WorkSpaceId").change(function () {
            var workSpaceId = $("#WorkSpaceId").data("kendoDropDownList").value();
            var tenentID = $("#TenantId").val();
            var ApplicationSecret = $("#ApplicationSecret").val();
            var ApplicationId = $("#ApplicationId").val();
            var reportDataSource;
            $.get("/DashboardReports/Get_ReportInGroup", { tenentID: tenentID, workSpaceId: workSpaceId, AppId: ApplicationId, AppSecret: ApplicationSecret },
                function (data) {
                    $("#ReportId").html('');
                    reportDataSource = data;
                    $("#ReportId").data("kendoDropDownList").setDataSource(new kendo.data.DataSource({ data: reportDataSource }));
                });

            var datasetDataSource;
            $.get("/DashboardReports/Get_Dataset", { tenentID: tenentID, workSpaceId: workSpaceId, AppId: ApplicationId, AppSecret: ApplicationSecret },
                function (data) {
                    $("#DatasetId").html('');
                    datasetDataSource = data;
                    $("#DatasetId").data("kendoDropDownList").setDataSource(new kendo.data.DataSource({ data: datasetDataSource }));
                });
        });

        $("#ReportId").change(function () {
            var reportId = $("#ReportId").data("kendoDropDownList").text();
            $("#ReportName").val(reportId);
        });
    }

    $(document).ready(function () {
        $("#btnRefreshAllDS").click(function () {
            var url = $(this).data("url");
            $.get(url, function (data) {
                $.notify('All datasets refreshed successfully.', { align: "right", verticalAlign: "top", type: "success", background: "#20D67B", color: "#fff" });
            });
        });

        $("#btnAddEditReport").on("click", function () {
            var url = $(this).data("url");
            $.get(url, function (data) {
                $('#createReportContainer').html(data);
                $('#createReportModal').modal('show');
                BindClickEvent();
            });
        });

        $("#btnDeleteConfirm").on("click", function () {
            var id = $("#hiddenId").val();
            $.ajax({
                url: '/DashboardReports/Delete/' + id,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function () {
                    //Refresh Kendo Grid
                    $('#PowerbiReportInfoGrid').data('kendoGrid').dataSource.read();
                    $('#PowerbiReportInfoGrid').data('kendoGrid').refresh();

                    $("#modalDelete").modal('hide');
                    $.notify('Data deleted successfully', { align: "right", verticalAlign: "top", type: "success", background: "#20D67B", color: "#fff" });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $.notify('Error deleting data!', { align: "right", verticalAlign: "top", type: "danger", background: "red", color: "#fff" });
                }
            });
        });

        $('#createReportContainer').on("click", ".btnAddData", function (e) {
            var formData = new FormData($('#formAssignment')[0]);
            console.log(formData);
            $.ajax({
                url: '/DashboardReports/AddEditPowerbiReportInfo',
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {

                    if (data.includes("successfully")) {
                        //Refresh Kendo Grid
                        $('#PowerbiReportInfoGrid').data('kendoGrid').dataSource.read();
                        $('#PowerbiReportInfoGrid').data('kendoGrid').refresh();

                        $.notify(data, { align: "right", verticalAlign: "top", type: "success", background: "#20D67B", color: "#fff" });
                        $('#createReportModal').modal('hide');
                    }
                    else if (data == "0") {
                        $.notify("Report Name already exists.", { align: "right", verticalAlign: "top", type: "danger", background: "red", color: "#fff" });
                        return;
                    }
                    else if (data == "0") {
                        $.notify("Report Name already exists.", { align: "right", verticalAlign: "top", type: "danger", background: "red", color: "#fff" });
                        return;
                    }
                    else {
                        $('#createReportContainer').html(data);
                        $('#createReportModal').modal('show');
                        return;
                    }
                },
                complete: function () {
                    console.log("complete");
                    $("form").each(function () { $.data($(this)[0], 'validator', false); });
                    $.validator.unobtrusive.parse("form");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    // alert(xhr.error);
                }
            });
        });

        $("#searching").keyup(function () {
            var selecteditem = $('#searching').val();
            var kgrid = $("#PowerbiReportInfoGrid").data("kendoGrid");
            selecteditem = selecteditem.toUpperCase();
            var selectedArray = selecteditem.split(" ");
            if (selecteditem) {
                var orfilter = { logic: "or", filters: [] };
                var andfilter = { logic: "and", filters: [] };
                $.each(selectedArray, function (i, v) {
                    if (v.trim() == "") {
                    }
                    else {
                        $.each(selectedArray, function (i, v1) {
                            if (v1.trim() == "") {
                            }
                            else {
                                orfilter.filters.push({ field: "ReportId", operator: "contains", value: v1 },
                                    { field: "WorkSpaceId", operator: "contains", value: v1 }
                                );
                                andfilter.filters.push(orfilter);
                                orfilter = { logic: "or", filters: [] };
                            }

                        });
                    }
                });
                kgrid.dataSource.filter(andfilter);
            }
            else {
                kgrid.dataSource.filter({});
            }

        });
    });

    function ClearValues() {
        $("#Id").val("0");
        $("#ReportName").val("");
        $("#ReportId").val("");
        $("#WorkSpaceId").val("");
        $("#ApplicationId").val("");
        $("#ApplicationSecret").val("");
        $("#TenantId").val("");
        $("#Description").val("");
        $("#MenuId").val("");
        $("#GroupId").val("");
        $("#imgPreview").attr("src", "/Uploads/PowerBiReportImages/powerbi_default.png");
    }

    function dataBound() {
        resetRowNumber();
        $(".btnEditPBiReport").on("click", function () {
            var url = $(this).data("url");
            $.get(url, function (data) {
                $('#createReportContainer').html(data);
                $('#createReportModal').modal('show');
            });
        });

        $(".ConfirmDelete").on("click", function (e) {
            e.preventDefault();
            var Id = $(this).data("key");
            $("#hiddenId").val(Id);
            $("#modalDelete").modal({ backdrop: 'static', keyboard: false, position: 'center' });
        });
    }

    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#imgPreview')
                    .attr('src', e.target.result)
                    .width(100)
                    .height(100);
            };

            reader.readAsDataURL(input.files[0]);
        }
    }

</script>